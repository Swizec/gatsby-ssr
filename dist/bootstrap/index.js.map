{"version":3,"sources":["../../src/bootstrap/index.js"],"names":["Promise","require","glob","_","slash","fs","md5File","crypto","del","apiRunnerNode","testRequireError","graphql","store","emitter","loadPlugins","initCache","report","process","on","reason","p","panic","extractQueries","runQueries","writePages","writeRedirects","preferDefault","m","default","module","exports","args","program","directory","dispatch","type","payload","activity","activityTimer","start","end","config","err","error","exit","flattenedPlugins","pluginVersions","map","version","hashes","all","resolve","catch","pluginsHash","createHash","update","JSON","stringify","concat","digest","state","getState","oldPluginsHash","status","PLUGINS_HASH","info","stripIndent","remove","e","ensureDirSync","srcDir","__dirname","siteDir","tryRequire","copy","clobber","emptyDir","hasAPIFile","env","plugin","sync","ssrPlugins","filter","options","pluginOptions","browserPlugins","browserAPIRunner","readFileSync","browserPluginsRequires","join","sSRAPIRunner","ssrPluginsRequires","writeFileSync","extensions","apiResults","traceId","flattenDeep","graphqlRunner","query","context","schema","waitForCascadingActions","NODE_ENV","checkJobsDone","debounce","jobs","active","length","log","uptime"],"mappings":"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","file":"index.js","sourcesContent":["/* @flow */\nconst Promise = require(`bluebird`)\n\nconst glob = require(`glob`)\nconst _ = require(`lodash`)\nconst slash = require(`slash`)\nconst fs = require(`fs-extra`)\nconst md5File = require(`md5-file/promise`)\nconst crypto = require(`crypto`)\nconst del = require(`del`)\n\nconst apiRunnerNode = require(`../utils/api-runner-node`)\nconst testRequireError = require(`../utils/test-require-error`)\nconst { graphql } = require(`graphql`)\nconst { store, emitter } = require(`../redux`)\nconst loadPlugins = require(`./load-plugins`)\nconst { initCache } = require(`../utils/cache`)\nconst report = require(`gatsby-cli/lib/reporter`)\n\n// Show stack trace on unhandled promises.\nprocess.on(`unhandledRejection`, (reason, p) => {\n  report.panic(reason)\n})\n\nconst {\n  extractQueries,\n} = require(`../internal-plugins/query-runner/query-watcher`)\nconst {\n  runQueries,\n} = require(`../internal-plugins/query-runner/page-query-runner`)\nconst { writePages } = require(`../internal-plugins/query-runner/pages-writer`)\nconst {\n  writeRedirects,\n} = require(`../internal-plugins/query-runner/redirects-writer`)\n\n// Override console.log to add the source file + line number.\n// Useful for debugging if you lose a console.log somewhere.\n// Otherwise leave commented out.\n// require(`./log-line-function`)\n\nconst preferDefault = m => (m && m.default) || m\n\ntype BootstrapArgs = {\n  directory: string,\n  prefixPaths?: boolean,\n}\n\nmodule.exports = async (args: BootstrapArgs) => {\n  const program = {\n    ...args,\n    // Fix program directory path for windows env.\n    directory: slash(args.directory),\n  }\n\n  store.dispatch({\n    type: `SET_PROGRAM`,\n    payload: program,\n  })\n\n  // Delete html files from the public directory as we don't want deleted\n  // pages from previous builds to stick around.\n  let activity = report.activityTimer(`delete html files from previous builds`)\n  activity.start()\n  await del([`public/*.html`, `public/**/*.html`])\n  activity.end()\n\n  // Try opening the site's gatsby-config.js file.\n  activity = report.activityTimer(`open and validate gatsby-config.js`)\n  activity.start()\n  let config\n  try {\n    // $FlowFixMe\n    config = preferDefault(require(`${program.directory}/gatsby-config`))\n  } catch (err) {\n    if (!testRequireError(`${program.directory}/gatsby-config`, err)) {\n      report.error(`Could not load gatsby-config`, err)\n      process.exit(1)\n    }\n  }\n\n  store.dispatch({\n    type: `SET_SITE_CONFIG`,\n    payload: config,\n  })\n\n  activity.end()\n\n  const flattenedPlugins = await loadPlugins(config)\n\n  // Check if any plugins have been updated since our last run. If so\n  // we delete the cache is there's likely been changes\n  // since the previous run.\n  //\n  // We do this by creating a hash of all the version numbers of installed\n  // plugins, the site's package.json, gatsby-config.js, and gatsby-node.js.\n  // The last, gatsby-node.js, is important as many gatsby sites put important\n  // logic in there e.g. generating slugs for custom pages.\n  const pluginVersions = flattenedPlugins.map(p => p.version)\n  const hashes = await Promise.all([\n    md5File(`package.json`),\n    Promise.resolve(\n      md5File(`${program.directory}/gatsby-config.js`).catch(() => {})\n    ), // ignore as this file isn't required),\n    Promise.resolve(\n      md5File(`${program.directory}/gatsby-node.js`).catch(() => {})\n    ), // ignore as this file isn't required),\n  ])\n  const pluginsHash = crypto\n    .createHash(`md5`)\n    .update(JSON.stringify(pluginVersions.concat(hashes)))\n    .digest(`hex`)\n  let state = store.getState()\n  const oldPluginsHash = state && state.status ? state.status.PLUGINS_HASH : ``\n\n  // Check if anything has changed. If it has, delete the site's .cache\n  // directory and tell reducers to empty themselves.\n  //\n  // Also if the hash isn't there, then delete things just in case something\n  // is weird.\n  if (oldPluginsHash && pluginsHash !== oldPluginsHash) {\n    report.info(report.stripIndent`\n      One or more of your plugins have changed since the last time you ran Gatsby. As\n      a precaution, we're deleting your site's cache to ensure there's not any stale\n      data\n    `)\n  }\n\n  if (!oldPluginsHash || pluginsHash !== oldPluginsHash) {\n    try {\n      await fs.remove(`${program.directory}/.cache`)\n    } catch (e) {\n      report.error(`Failed to remove .cache files.`, e)\n    }\n    // Tell reducers to delete their data (the store will already have\n    // been loaded from the file system cache).\n    store.dispatch({\n      type: `DELETE_CACHE`,\n    })\n  }\n\n  // Update the store with the new plugins hash.\n  store.dispatch({\n    type: `UPDATE_PLUGINS_HASH`,\n    payload: pluginsHash,\n  })\n\n  // Now that we know the .cache directory is safe, initialize the cache\n  // directory.\n  initCache()\n\n  // Ensure the public/static directory is created.\n  await fs.ensureDirSync(`${program.directory}/public/static`)\n\n  // Copy our site files to the root of the site.\n  activity = report.activityTimer(`copy gatsby files`)\n  activity.start()\n  const srcDir = `${__dirname}/../../cache-dir`\n  const siteDir = `${program.directory}/.cache`\n  const tryRequire = `${__dirname}/../utils/test-require-error.js`\n  try {\n    await fs.copy(srcDir, siteDir, { clobber: true })\n    await fs.copy(tryRequire, `${siteDir}/test-require-error.js`, {\n      clobber: true,\n    })\n    await fs.ensureDirSync(`${program.directory}/.cache/json`)\n    await fs.ensureDirSync(`${program.directory}/.cache/layouts`)\n\n    // Ensure .cache/fragments exists and is empty. We want fragments to be\n    // added on every run in response to data as fragments can only be added if\n    // the data used to create the schema they're dependent on is available.\n    await fs.emptyDir(`${program.directory}/.cache/fragments`)\n  } catch (err) {\n    report.panic(`Unable to copy site files to .cache`, err)\n  }\n\n  // Find plugins which implement gatsby-browser and gatsby-ssr and write\n  // out api-runners for them.\n  const hasAPIFile = (env, plugin) =>\n    // TODO make this async...\n    glob.sync(`${plugin.resolve}/gatsby-${env}*`)[0]\n\n  const ssrPlugins = _.filter(\n    flattenedPlugins.map(plugin => {\n      return {\n        resolve: hasAPIFile(`ssr`, plugin),\n        options: plugin.pluginOptions,\n      }\n    }),\n    plugin => plugin.resolve\n  )\n  const browserPlugins = _.filter(\n    flattenedPlugins.map(plugin => {\n      return {\n        resolve: hasAPIFile(`browser`, plugin),\n        options: plugin.pluginOptions,\n      }\n    }),\n    plugin => plugin.resolve\n  )\n\n  let browserAPIRunner = ``\n\n  try {\n    browserAPIRunner = fs.readFileSync(\n      `${siteDir}/api-runner-browser.js`,\n      `utf-8`\n    )\n  } catch (err) {\n    report.panic(`Failed to read ${siteDir}/api-runner-browser.js`, err)\n  }\n\n  const browserPluginsRequires = browserPlugins\n    .map(\n      plugin =>\n        `{\n      plugin: require('${plugin.resolve}'),\n      options: ${JSON.stringify(plugin.options)},\n    }`\n    )\n    .join(`,`)\n\n  browserAPIRunner = `var plugins = [${browserPluginsRequires}]\\n${browserAPIRunner}`\n\n  let sSRAPIRunner = ``\n\n  try {\n    sSRAPIRunner = fs.readFileSync(`${siteDir}/api-runner-ssr.js`, `utf-8`)\n  } catch (err) {\n    report.panic(`Failed to read ${siteDir}/api-runner-ssr.js`, err)\n  }\n\n  const ssrPluginsRequires = ssrPlugins\n    .map(\n      plugin =>\n        `{\n      plugin: require('${plugin.resolve}'),\n      options: ${JSON.stringify(plugin.options)},\n    }`\n    )\n    .join(`,`)\n  sSRAPIRunner = `var plugins = [${ssrPluginsRequires}]\\n${sSRAPIRunner}`\n\n  fs.writeFileSync(\n    `${siteDir}/api-runner-browser.js`,\n    browserAPIRunner,\n    `utf-8`\n  )\n  fs.writeFileSync(`${siteDir}/api-runner-ssr.js`, sSRAPIRunner, `utf-8`)\n\n  activity.end()\n  /**\n   * Start the main bootstrap processes.\n   */\n\n  // onPreBootstrap\n  activity = report.activityTimer(`onPreBootstrap`)\n  activity.start()\n  await apiRunnerNode(`onPreBootstrap`)\n  activity.end()\n\n  // Source nodes\n  activity = report.activityTimer(`source and transform nodes`)\n  activity.start()\n  await require(`../utils/source-nodes`)()\n  activity.end()\n\n  // Create Schema.\n  activity = report.activityTimer(`building schema`)\n  activity.start()\n  await require(`../schema`)()\n  activity.end()\n\n  // Collect resolvable extensions and attach to program.\n  const extensions = [`.js`, `.jsx`]\n  // Change to this being an action and plugins implement `onPreBootstrap`\n  // for adding extensions.\n  const apiResults = await apiRunnerNode(`resolvableExtensions`, {\n    traceId: `initial-resolvableExtensions`,\n  })\n\n  store.dispatch({\n    type: `SET_PROGRAM_EXTENSIONS`,\n    payload: _.flattenDeep([extensions, apiResults]),\n  })\n\n  const graphqlRunner = (query, context = {}) => {\n    const schema = store.getState().schema\n    return graphql(schema, query, context, context, context)\n  }\n\n  // Collect layouts.\n  activity = report.activityTimer(`createLayouts`)\n  activity.start()\n  await apiRunnerNode(`createLayouts`, {\n    graphql: graphqlRunner,\n    traceId: `initial-createLayouts`,\n    waitForCascadingActions: true,\n  })\n  activity.end()\n\n  // Collect pages.\n  activity = report.activityTimer(`createPages`)\n  activity.start()\n  await apiRunnerNode(`createPages`, {\n    graphql: graphqlRunner,\n    traceId: `initial-createPages`,\n    waitForCascadingActions: true,\n  })\n  activity.end()\n\n  // A variant on createPages for plugins that want to\n  // have full control over adding/removing pages. The normal\n  // \"createPages\" API is called every time (during development)\n  // that data changes.\n  activity = report.activityTimer(`createPagesStatefully`)\n  activity.start()\n  await apiRunnerNode(`createPagesStatefully`, {\n    graphql: graphqlRunner,\n    traceId: `initial-createPagesStatefully`,\n    waitForCascadingActions: true,\n  })\n  activity.end()\n\n  activity = report.activityTimer(`onPreExtractQueries`)\n  activity.start()\n  await apiRunnerNode(`onPreExtractQueries`)\n  activity.end()\n\n  // Extract queries\n  activity = report.activityTimer(`extract queries from components`)\n  activity.start()\n  await extractQueries()\n  activity.end()\n\n  // Start the createPages hot reloader.\n  if (process.env.NODE_ENV !== `production`) {\n    require(`./page-hot-reloader`)(graphqlRunner)\n  }\n\n  // Run queries\n  activity = report.activityTimer(`run graphql queries`)\n  activity.start()\n  await runQueries()\n  activity.end()\n\n  // Write out files.\n  activity = report.activityTimer(`write out page data`)\n  activity.start()\n  await writePages()\n  activity.end()\n\n  // Write out redirects.\n  activity = report.activityTimer(`write out redirect data`)\n  activity.start()\n  await writeRedirects()\n  activity.end()\n\n  // Update Schema for SitePage.\n  activity = report.activityTimer(`update schema`)\n  activity.start()\n  await require(`../schema`)()\n  activity.end()\n\n  const checkJobsDone = _.debounce(resolve => {\n    const state = store.getState()\n    if (state.jobs.active.length === 0) {\n      report.log(``)\n      report.info(`bootstrap finished - ${process.uptime()} s`)\n      report.log(``)\n      resolve({ graphqlRunner })\n    }\n  }, 100)\n\n  if (store.getState().jobs.active.length === 0) {\n    // onPostBootstrap\n    activity = report.activityTimer(`onPostBootstrap`)\n    activity.start()\n    await apiRunnerNode(`onPostBootstrap`)\n    activity.end()\n\n    report.log(``)\n    report.info(`bootstrap finished - ${process.uptime()} s`)\n    report.log(``)\n    return { graphqlRunner }\n  } else {\n    return new Promise(resolve => {\n      // Wait until all side effect jobs are finished.\n      emitter.on(`END_JOB`, () => checkJobsDone(resolve))\n    })\n  }\n}\n"]}